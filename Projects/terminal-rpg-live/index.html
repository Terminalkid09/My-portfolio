<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal RPG Adventure - Live in Browser</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <style>
        body { 
            background: #000; 
            color: #00ff00; 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            margin: 0;
        }
        h1 { 
            text-align: center; 
            text-shadow: 0 0 10px #00ff00; 
        }
        #output { 
            white-space: pre-wrap; 
            min-height: 70vh; 
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            overflow-y: auto;
        }
        input { 
            background: #000; 
            color: #00ff00; 
            border: 1px solid #00ff00; 
            font-family: monospace; 
            width: 100%; 
            padding: 10px; 
            font-size: 16px; 
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>üéÆ Terminal RPG Adventure - Play in Browser</h1>
    <div id="output">Loading Python environment... Please wait...</div>
    <input type="text" id="input" autofocus placeholder="Type your choice and press Enter">

    <script type="text/javascript">
        async function main() {
            let pyodide = await loadPyodide();
            let output = document.getElementById("output");
            let input = document.getElementById("input");

            output.innerHTML = "Python loaded! Starting game...\n\n";

            let code = `
import random

player = {
    "name": "Hero",
    "hp": 50,
    "max_hp": 50,
    "base_attack": 5,
    "base_defense": 2,
    "weapon_bonus": 0,
    "armor_bonus": 0,
    "gold": 30,
    "inventory": [],
    "weapon": "None",
    "armor": "Cloth Tunic"
}

def get_attack():
    return player["base_attack"] + player["weapon_bonus"]

def get_defense():
    return player["base_defense"] + player["armor_bonus"]

areas = {
    "forest": {
        "name": "Dark Forest",
        "enemies": [
            {"name": "Goblin", "hp": 20, "attack": 5, "gold": 8},
            {"name": "Wolf", "hp": 24, "attack": 6, "gold": 10}
        ],
        "boss": {"name": "Forest Troll", "hp": 40, "attack": 8, "gold": 25}
    },
    "mountain": {
        "name": "Mountain Pass",
        "enemies": [
            {"name": "Bandit", "hp": 26, "attack": 7, "gold": 12},
            {"name": "Rock Golem", "hp": 32, "attack": 8, "gold": 14}
        ],
        "boss": {"name": "Minotaur", "hp": 48, "attack": 10, "gold": 30}
    },
    "lake": {
        "name": "Misty Lake",
        "enemies": [
            {"name": "Water Spirit", "hp": 22, "attack": 6, "gold": 10},
            {"name": "Serpent", "hp": 30, "attack": 7, "gold": 14}
        ],
        "boss": {"name": "Kraken Spawn", "hp": 50, "attack": 11, "gold": 32}
    },
    "desert": {
        "name": "Burning Desert",
        "enemies": [
            {"name": "Scorpion", "hp": 24, "attack": 7, "gold": 11},
            {"name": "Sand Thief", "hp": 28, "attack": 8, "gold": 15}
        ],
        "boss": {"name": "Sand Wraith", "hp": 45, "attack": 9, "gold": 28}
    }
}

def world_map():
    while True:
        print("\\nüó∫Ô∏è WORLD MAP")
        print(f"HP: {player['hp']}/{player['max_hp']} | ATK: {get_attack()} | DEF: {get_defense()} | Gold: {player['gold']}")
        print(f"Weapon: {player['weapon']} | Armor: {player['armor']}")
        print("\\nWhere do you want to go?")
        print("1) Dark Forest")
        print("2) Mountain Pass")
        print("3) Misty Lake")
        print("4) Burning Desert")
        print("5) Village")
        print("6) Quit game")

        choice = input("‚Üí ")

        if choice == "1":
            explore_area("forest")
        elif choice == "2":
            explore_area("mountain")
        elif choice == "3":
            explore_area("lake")
        elif choice == "4":
            explore_area("desert")
        elif choice == "5":
            village()
        elif choice == "6":
            print("Thanks for playing!")
            break
        else:
            print("Invalid choice.")

def explore_area(key):
    area = areas[key]
    print(f"\\nüåÑ You travel to the {area['name']}...")

    random_npc_event(key)

    for enemy in area["enemies"]:
        combat(enemy)

    print(f"\\nüî• A powerful presence approaches in the {area['name']}...")
    boss = area["boss"]
    boss_result = combat(boss, is_boss=True)
    if boss_result:
        print(f"\\nüèÜ You have cleared the {area['name']}!")
    input("\\nPress ENTER to return to the world map...")

def village():
    while True:
        print("\\nüèòÔ∏è You arrive at the village.")
        print(f"HP: {player['hp']}/{player['max_hp']} | Gold: {player['gold']}")
        print("1) Visit Shop")
        print("2) Talk to NPCs")
        print("3) Rest at Inn (+20 HP, 5 gold)")
        print("4) Return to World Map")

        choice = input("‚Üí ")

        if choice == "1":
            shop()
        elif choice == "2":
            village_npc()
        elif choice == "3":
            rest_inn()
        elif choice == "4":
            return
        else:
            print("Invalid choice.")

def rest_inn():
    if player["gold"] < 5:
        print("\\nYou don't have enough gold to rest.")
        return
    player["gold"] -= 5
    heal = 20
    player["hp"] = min(player["hp"] + heal, player["max_hp"])
    print(f"\\nYou rest at the inn. (+{heal} HP)")

def shop():
    while True:
        print("\\nüè™ Village Shop")
        print(f"Gold: {player['gold']}")
        print("Items for sale:")
        print("1) Potion (+20 HP) - 8 gold")
        print("2) Iron Sword (+3 ATK) - 20 gold")
        print("3) Steel Armor (+3 DEF) - 20 gold")
        print("4) Back")

        choice = input("‚Üí ")

        if choice == "1":
            buy_item("Potion", 8)
        elif choice == "2":
            buy_weapon("Iron Sword", bonus=3, cost=20)
        elif choice == "3":
            buy_armor("Steel Armor", bonus=3, cost=20)
        elif choice == "4":
            return
        else:
            print("Invalid choice.")

def buy_item(item_name, cost):
    if player["gold"] < cost:
        print("Not enough gold.")
        return
    player["gold"] -= cost
    player["inventory"].append(item_name)
    print(f"You bought a {item_name}.")

def buy_weapon(name, bonus, cost):
    if player["gold"] < cost:
        print("Not enough gold.")
        return
    player["gold"] -= cost
    player["weapon"] = name
    player["weapon_bonus"] = bonus
    print(f"You equipped {name}. Attack increased!")

def buy_armor(name, bonus, cost):
    if player["gold"] < cost:
        print("Not enough gold.")
        return
    player["gold"] -= cost
    player["armor"] = name
    player["armor_bonus"] = bonus
    print(f"You equipped {name}. Defense increased!")

def village_npc():
    while True:
        print("\\nüèòÔ∏è Village NPCs")
        print("1) Talk to Old Sage")
        print("2) Talk to Village Guard")
        print("3) Talk to Traveling Merchant")
        print("4) Back")

        choice = input("‚Üí ")

        if choice == "1":
            npc_dialog("Old Sage")
        elif choice == "2":
            npc_dialog("Village Guard")
        elif choice == "3":
            npc_dialog("Traveling Merchant")
        elif choice == "4":
            return
        else:
            print("Invalid choice.")

def npc_dialog(npc_name):
    print(f"\\nüí¨ You meet {npc_name}.")

    if npc_name == "Old Sage":
        print("\\nOld Sage: 'Traveler... the world is full of dangers.'")
        print("1) Ask for wisdom")
        print("2) Ask for healing")
        print("3) Leave")
        choice = input("‚Üí ")

        if choice == "1":
            print("\\nOld Sage: 'Bosses fall easier to those who prepare their gear and heal in time.'")
        elif choice == "2":
            heal = 15
            player["hp"] = min(player["hp"] + heal, player["max_hp"])
            print(f"\\nOld Sage: 'Be well, child.' (+{heal} HP)")
        else:
            print("\\nOld Sage: 'Farewell.'")

    elif npc_name == "Village Guard":
        print("\\nGuard: 'Stay out of trouble, adventurer.'")
        print("1) Ask about dangers")
        print("2) Ask about treasure")
        print("3) Leave")
        choice = input("‚Üí ")

        if choice == "1":
            print("\\nGuard: 'The mountain beasts hit hard. Bring armor.'")
        elif choice == "2":
            print("\\nGuard: 'They say the lake hides something ancient and powerful.'")
        else:
            print("\\nGuard: 'Move along.'")

    elif npc_name == "Traveling Merchant":
        print("\\nMerchant: 'Greetings! I have something for you.'")
        print("1) Receive a free Potion")
        print("2) Receive a random trinket")
        print("3) Leave")
        choice = input("‚Üí ")

        if choice == "1":
            player["inventory"].append("Potion")
            print("\\nMerchant: 'Use it wisely.' (Potion added)")
        elif choice == "2":
            item = random.choice(["Magic Feather", "Lucky Charm", "Old Map"])
            player["inventory"].append(item)
            print(f"\\nMerchant: 'A fine choice!' ({item} added)")
        else:
            print("\\nMerchant: 'Safe travels.'")

    input("\\nPress ENTER to continue...")

def random_npc_event(area_key):
    if random.random() < 0.3:
        npc = random.choice(["Lost Explorer", "Forest Spirit", "Wandering Monk"])
        print(f"\\n‚ú® You encounter a {npc} on your journey.")
        print(f"{npc}:")
        if npc == "Lost Explorer":
            print("'I‚Äôve been wandering here for days... take this, it might help you.'")
            player["inventory"].append("Potion")
            print("You received a Potion!")
        elif npc == "Forest Spirit":
            heal = 10
            player["hp"] = min(player["hp"] + heal, player["max_hp"])
            print(f"'Your spirit is seen. Be healed.' (+{heal} HP)")
        else:
            print("'Silence is also an answer...' (nothing happens)")
        input("\\nPress ENTER to continue...")

def combat(enemy, is_boss=False):
    enemy_name = enemy["name"]
    enemy_hp = enemy["hp"]
    enemy_attack = enemy["attack"]
    enemy_gold = enemy["gold"]

    print(f"\\n‚öîÔ∏è A {enemy_name} appears!")
    if is_boss:
        print("üî• This is a BOSS fight!")

    while player["hp"] > 0 and enemy_hp > 0:
        print(f"\\nYour HP: {player['hp']}/{player['max_hp']} | {enemy_name} HP: {enemy_hp}")
        print("1) Attack")
        print("2) Defend")
        print("3) Use item")
        print("4) Run away" + (" (can't run from boss!)" if is_boss else ""))
        action = input("‚Üí ")

        defended = False

        if action == "1":
            dmg = random.randint(get_attack(), get_attack() + 4)
            enemy_hp -= dmg
            print(f"You strike the {enemy_name} for {dmg} damage!")
        elif action == "2":
            defended = True
            print("You brace yourself for the attack.")
        elif action == "3":
            use_item()
        elif action == "4" and not is_boss:
            print("You run away safely...")
            return False
        elif action == "4" and is_boss:
            print("You cannot escape from a boss!")
        else:
            print("Invalid action.")
            continue

        if enemy_hp > 0:
            dmg_taken = random.randint(enemy_attack - 2, enemy_attack + 2)
            dmg_taken = max(1, dmg_taken - get_defense())
            if defended:
                dmg_taken //= 2
            player["hp"] -= dmg_taken
            print(f"The {enemy_name} hits you for {dmg_taken} damage.")

    if player["hp"] <= 0:
        print("\\nüíÄ You have fallen in battle...")
        print("Game over.")
        # exit() non funziona in browser, quindi fermiamo
        return

    print(f"\\nüéâ You defeated the {enemy_name}!")
    print(f"You receive {enemy_gold} gold.")
    player["gold"] += enemy_gold
    loot = random.choice(["Nothing", "Potion", "Bomb", "Trinket"])
    if loot != "Nothing":
        if loot == "Trinket":
            loot = random.choice(["Ancient Coin", "Shiny Gem", "Old Ring"])
        player["inventory"].append(loot)
        print(f"You found: {loot}")
    return True

def use_item():
    if not player["inventory"]:
        print("\\nYou have no items.")
        return

    print("\\nüéí Your inventory:")
    for i, item in enumerate(player["inventory"], start=1):
        print(f"{i}) {item}")
    print(f"{len(player['inventory']) + 1}) Cancel")

    choice = input("Choose an item: ")

    if not choice.isdigit():
        print("Invalid choice.")
        return

    idx = int(choice)
    if idx == len(player["inventory"]) + 1:
        return
    if idx < 1 or idx > len(player["inventory"]):
        print("Invalid choice.")
        return

    item = player["inventory"].pop(idx - 1)

    if item == "Potion":
        heal = 20
        player["hp"] = min(player["hp"] + heal, player["max_hp"])
        print(f"You drink a Potion and heal {heal} HP.")
    elif item == "Bomb":
        print("You throw a Bomb! (In this simple version, it just looks cool.)")
    else:
        print(f"You inspect the {item}. It has no obvious use... yet.")

def start_game():
    print("=== FULL TERMINAL RPG ADVENTURE ===")
    world_map()

start_game()
`;

            pyodide.runPython(code);

            // Output handling
            pyodide.setStdout({
                batched: (text) => {
                    output.innerHTML += text.replace(/\\n/g, '<br>') + "<br>";
                    output.scrollTop = output.scrollHeight;
                }
            });

            // Simple input handling
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    let value = input.value;
                    output.innerHTML += "> " + value + "<br>";
                    pyodide.globals.set("last_input", value + "\\n");
                    input.value = "";
                    output.scrollTop = output.scrollHeight;
                }
            });
        }
        main();
    </script>
</body>
</html>